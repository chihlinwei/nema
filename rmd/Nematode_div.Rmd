---
title: "Nematode Diversity"
author: "Wei, C.-L., Liao, J.-X."
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

# Reguired package
```{r}
library(nema)
library(iNEXT)
library(ggplot2)
library(reshape2)
library(vegan)
library(plyr)
library(viridis)
library(doBy)
library(cowplot)
library(knitr)
library(nlme)
```

# ggplot theme setting
```{r}
large <- theme(legend.title = element_text(size=15),
        legend.text = element_text(size=15),
        axis.title = element_text(size=15),
        axis.text = element_text(size=15),
        strip.text = element_text(size=15))

rotate <- theme(axis.text.x = element_text(angle = 30, hjust=0.5))

no_strip <- theme(strip.background = element_rect(colour=NA, fill=NA),
                  strip.text = element_text(colour=NA))
```

# Preparing nematode and environmental data
Relative abundance of nematode species from 100 randomly slected individuals was scaled to the total nematode abundance in each sample.
```{r}
# Convert to species-by-sample matrix
b <- acast(nema_abund, Cruise+Station+Deployment+Tube+Subcore~Genus+Species, fill=0)
# Multiply the relative abundance by total abundance
#b <- ceiling(decostand(b, "total")*nema_total$Abundance)

# Match environmental data to neamtode sample
e <- ldply(strsplit(row.names(b), split="_"))
e <- cbind(with(e, paste(V1, V2, sep="_")), e[,-1:-2])
names(e) <- c("Cruise", "Station", "Deployment", "Tube", "Subcore")
id1 <- with(e, paste(Cruise, Station, Deployment))
id2 <- with(nema_cruise, paste(Cruise, Station, Deployment))
e <- cbind(e, nema_cruise[match(id1, id2), -3:-5])

# Define depth zone
depth.bk <- c(200, 400, 600, 800, 1100)
depth.lab <- c("200-400", "400-600", "600-800", "800-1100")
e$Zone <- cut(e$Depth, breaks=depth.bk, labels=depth.lab)

# Match the trait data to the species-by-sample matrix
s <- nema_species[match(colnames(b), with(nema_species, paste(Genus, Species, sep="_"))),]
```
# Abundance
```{r, fig.width=6, fig.height=4}
ggplot(data=cbind(Abund=nema_total$Abundance, e), 
       aes(x=Depth, y=Abund, colour=Habitat))+
  geom_point(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), size=5,
                  position=position_jitter(width=10))+
  labs(x="Depth (m)", y="Number of Individual")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  scale_y_log10()+
  theme_bw() %+replace% large

# Linear regression
hl <- splitBy(~Habitat, cbind(Abund=nema_total$Abundance, e))
lapply(hl, FUN=function(x)summary(lm(log10(Abund)~Depth, data=x)))

# Linear Mixed-Effects Models
f <- lme(fixed = log10(Abund) ~ Habitat*Depth, random = ~1|Cruise, data=cbind(Abund=nema_total$Abundance, e), method = "REML", weights=varIdent(form=~1|Cruise))
summary(f)
```

```{r, fig.width=6, fig.height=4}
out <- summaryBy(Abund~Cruise+Station+Habitat+Zone, data=cbind(Abund=nema_total$Abundance, e), FUN=c(mean, sd))
out$Date <- factor(out$Cruise, labels=c("2015-08", "2015-11"))
names(out)[5:6] <- c("Abund", "sd")

ggplot(data=out, aes(x=Zone, y=Abund, ymin=Abund, ymax=Abund+sd, fill=Date))+
  geom_errorbar(position="dodge")+
  geom_bar(stat="identity", position="dodge", colour=gray(0, 0.2))+
  facet_wrap(~Habitat)+
  labs(x="Depth (m)", y="Number of Individual")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  scale_y_log10()+
  theme_bw() %+replace% large %+replace% theme(axis.text.x=element_text(angle=30))
```

# Estimate Hill Numbers
* Bootstrap confidence interval (1000 iterations)
```{r, eval=FALSE}
q0 <- iNEXT(t(b), q = 0, size=1:200, nboot=1000)
q1 <- iNEXT(t(b), q = 1, size=1:200, nboot=1000)
q2 <- iNEXT(t(b), q = 2, size=1:200, nboot=1000)
save(list=c("q0", "q1", "q2"), file="../rda/HillNumbers.rda")
```

```{r}
load("../rda/HillNumbers.rda")

# 50% sample completeness
#h0 <- ldply(lapply(q0$iNextEst, FUN=function(x)subset(x, SC>0.5)[1,]), .id="Sample")
#h1 <- ldply(lapply(q1$iNextEst, FUN=function(x)subset(x, SC>0.5)[1,]), .id="Sample")
#h2 <- ldply(lapply(q2$iNextEst, FUN=function(x)subset(x, SC>0.5)[1,]), .id="Sample")

# 50 randomly selected individual
h0 <- subset(ldply(q0$iNextEst, .id="Sample"), m==50)
h1 <- subset(ldply(q1$iNextEst, .id="Sample"), m==50)
h2 <- subset(ldply(q2$iNextEst, .id="Sample"), m==50)
```


## q=0 or species richness
```{r, fig.width=6, fig.height=4}
ggplot(data=cbind(h0, e), 
       aes(x=Depth, y=qD, ymin=qD.LCL, ymax=qD.UCL, colour=Habitat))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten = 10, 
                  position=position_jitter(width=10))+
  stat_smooth(method="lm", fill="gray60")+
  labs(x="Depth (m)", y="Effective Number of Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

# Linear regression
hl <- splitBy(~Habitat, subset(cbind(h0, e), Sample!="OR1_1126_GC2_1_9_3"))
lapply(hl, FUN=function(x)summary(lm(qD~Depth, data=x)))

# Linear Mixed-Effects Models
f <- lme(fixed = qD ~ Habitat*Depth, random = ~1|Cruise, data=cbind(h0, e), method = "REML", weights=varIdent(form=~1|Cruise))
summary(f)
```

```{r, fig.width=6, fig.height=4}
out <- cbind(h0, Abund=nema_total$Abundance,e)
out$Date <- factor(out$Cruise, labels=c("2015-08", "2015-11"))
ggplot(data=out, aes(x=Abund, y=qD, colour=Habitat, shape=Date))+
  geom_point(size=5)+
  labs(x="Number of Individual", y="Effective Number of Species")+
  scale_shape_manual(values=c(1, 19))+
  scale_x_log10()+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```


## q=1 or exponential Shannon diversity
```{r, fig.width=6, fig.height=4}
ggplot(data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=Depth, y=qD, ymin=qD.LCL, ymax=qD.UCL, colour=Habitat))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten = 10, 
                  position=position_jitter(width=10))+
  stat_smooth(method="lm", fill="gray60")+
  labs(x="Depth (m)", y="Effective Number of Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

# Linear regression
hl <- splitBy(~Habitat, subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"))
lapply(hl, FUN=function(x)summary(lm(qD~Depth, data=x)))

# Linear Mixed-Effects Models
f <- lme(fixed = qD ~ Habitat*Depth, random = ~1|Cruise, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), method = "REML", weights=varIdent(form=~1|Cruise))
summary(f)
```

```{r, fig.width=6, fig.height=4}
out <- subset(cbind(h1, Abund=nema_total$Abundance,e), Sample!="OR1_1126_GC2_1_9_3")
out$Date <- factor(out$Cruise, labels=c("2015-08", "2015-11"))
ggplot(data=out, aes(x=Abund, y=qD, colour=Habitat, shape=Date))+
  geom_point(size=5)+
  labs(x="Number of Individual", y="Effective Number of Species")+
  scale_shape_manual(values=c(1, 19))+
  scale_x_log10()+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

```{r, fig.width=6, fig.height=4}
out <- summaryBy(qD~Cruise+Station+Habitat+Zone, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), FUN=c(mean, sd))
out$Date <- factor(out$Cruise, labels=c("2015-08", "2015-11"))
names(out)[5:6] <- c("qD", "sd")

ggplot(data=out, aes(x=Zone, y=qD, ymin=qD, ymax=qD+sd, fill=Date))+
  geom_errorbar(position="dodge")+
  geom_bar(stat="identity", position="dodge", colour=gray(0, 0.2))+
  facet_wrap(~Habitat)+
  labs(x="Depth (m)", y="Effective Number of Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large %+replace% theme(axis.text.x=element_text(angle=30))
```

## q=2 or inverse Simpson diversity
```{r, fig.width=6, fig.height=4}
ggplot(data=subset(cbind(h2, e), Sample!="OR1_1126_GC2_1_9_2" & Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=Depth, y=qD, ymin=qD.LCL, ymax=qD.UCL, colour=Habitat))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten = 10, 
                  position=position_jitter(width=10))+
  stat_smooth(method="lm", fill="gray60")+
  labs(x="Depth (m)", y="Effective Number of Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

# Linear regression
hl <- splitBy(~Habitat, subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_2" & Sample!="OR1_1126_GC2_1_9_3"))
lapply(hl, FUN=function(x)summary(lm(qD~Depth, data=x)))

# Linear Mixed-Effects Models
f <- lme(fixed = qD ~ Habitat*Depth, random = ~1|Cruise, data=subset(cbind(h2, e), Sample!="OR1_1126_GC2_1_9_2" & Sample!="OR1_1126_GC2_1_9_3"), method = "REML", weights=varIdent(form=~1|Cruise))
summary(f)
```

```{r, fig.width=6, fig.height=4}
out <- subset(cbind(h2, Abund=nema_total$Abundance,e), Sample!="OR1_1126_GC2_1_9_2" & Sample!="OR1_1126_GC2_1_9_3")
out$Date <- factor(out$Cruise, labels=c("2015-08", "2015-11"))
ggplot(data=out, aes(x=Abund, y=qD, colour=Habitat, shape=Date))+
  geom_point(size=5)+
  labs(x="Number of Individual", y="Effective Number of Species")+
  scale_shape_manual(values=c(1, 19))+
  scale_x_log10()+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

# Correlation bettwen exponential Shannon (q=1) and environmental factor
```{r, fig.width=4.5, fig.height=4}
p1 <- ggplot(data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=Speed, y=qD, ymin=qD.LCL, ymax=qD.UCL))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten=10)+
  stat_smooth(method="lm", fill="gray60", colour="gray50")+
  labs(x="Modeled Current Velocity (m/s)", y="Effective Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large %+replace% theme(legend.position="none")

cor.test(formula=~qD+Speed, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"))
```

```{r, fig.width=4.5, fig.height=4}
p2 <- ggplot(data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=over20, y=qD, ymin=qD.LCL, ymax=qD.UCL))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten=10)+
  stat_smooth(method="lm", fill="gray60", colour="gray50")+
  labs(x="Modeled Duration of Erosion (hr)", y="Effective Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large %+replace% theme(legend.position="none")

cor.test(formula=~qD+over20, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"))
```

```{r, fig.width=4.5, fig.height=4}
p3 <- ggplot(data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=transmissometer, y=qD, ymin=qD.LCL, ymax=qD.UCL))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten=10)+
  stat_smooth(method="lm", fill="gray60", colour="gray50")+
  labs(x="Light Transmission (%)", y="Effective Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large %+replace% theme(legend.position="none")

cor.test(formula=~qD+transmissometer, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"))
```

```{r, fig.width=4.5, fig.height=4}
p4 <- ggplot(data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"), 
       aes(x=TOC, y=qD, ymin=qD.LCL, ymax=qD.UCL))+
  geom_pointrange(aes(fill=Habitat), pch=21, colour=gray(0, 0.2), fatten=10)+
  stat_smooth(method="lm", fill="gray60", colour="gray50")+
  labs(x="Total Organic Carbon (%)", y="Effective Species")+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large %+replace% theme(legend.position="none")

cor.test(formula=~qD+TOC, data=subset(cbind(h1, e), Sample!="OR1_1126_GC2_1_9_3"))
```

```{r, fig.width=10, fig.height=3}
plot_grid(p1, p4, ncol=2, align = "h", axis="b")
```

```{r, fig.width=10, fig.height=3}
plot_grid(p2, p3, ncol=2, align = "h", axis="b")
```

```{r}
out <- cbind(e[, 1:5], q0$DataInfo[,2:4], "0D"=h0$qD, "1D" = h1$qD, "2D"=h2$qD)
row.names(out) <- NULL
# Outliers, the confidence interval too large 
out[out$Cruise=="OR1_1126" & out$Station=="GC2" & out$Subcore == 2, c("2D")] <- NA
out[out$Cruise=="OR1_1126" & out$Station=="GC2" & out$Subcore == 3, c("1D", "2D")] <- NA
kable(out)
```

