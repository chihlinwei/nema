---
title: "Nematode Composition"
author: "Wei, C.-L., Liao, J.-X."
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

# Reguired package
```{r}
library(nema)
library(reshape2)
library(plyr)
library(vegan)
library(viridis)
library(ggdendro)
library(ggplot2)
library(ggrepel)
library(betapart)
library(doBy)
library(knitr)
```

# ggplot them setting
```{r}
large <- theme(legend.title = element_text(size=15),
        legend.text = element_text(size=15),
        axis.title = element_text(size=15),
        axis.text = element_text(size=15),
        strip.text = element_text(size=15))

rotate <- theme(axis.text.x = element_text(angle = 30, hjust=0.5))

no_strip <- theme(strip.background = element_rect(colour=NA, fill=NA),
                  strip.text = element_text(colour=NA))
```

# Preparing nematode and environmental data
```{r}
# Convert to species-by-sample matrix
b <- acast(nema_abund, Cruise+Station+Deployment+Tube+Subcore~Genus+Species, fill=0)

# Match environmental data to neamtode sample
e <- ldply(strsplit(row.names(b), split="_"))
e <- cbind(with(e, paste(V1, V2, sep="_")), e[,-1:-2])
names(e) <- c("Cruise", "Station", "Deployment", "Tube", "Subcore")
id1 <- with(e, paste(Cruise, Station, Deployment))
id2 <- with(nema_cruise, paste(Cruise, Station, Deployment))
e <- cbind(e, nema_cruise[match(id1, id2), -3:-5])

# Define depth zone
depth.bk <- c(200, 400, 600, 800, 1100)
depth.lab <- c("200-400", "400-600", "600-800", "800-1100")
e$Zone <- cut(e$Depth, breaks=depth.bk, labels=depth.lab)

# Match the trait data to the species-by-sample matrix
s <- nema_species[match(colnames(b), with(nema_species, paste(Genus, Species, sep="_"))),]
```

# Cluster Analysis and 
```{r, fig.width=8, fig.height=3}
# Hierarchical Clustering based on square root transformed abundance data 
# Agglomeration used group average (= UPGMA) method
d <- vegdist(b^0.25)
hc <- hclust(d, method="average")
hc$labels <- with(e, paste(gsub("OR1_", "", Cruise), Station, sep="-"))

# Convert dendrogram to ggplot style
dhc <- as.dendrogram(hc)
ghc    <- dendro_data(dhc, type="rectangle") 

# Merge env data to dendrogram label data frame
ord <- match(label(ghc)$label, with(e, paste(gsub("OR1_", "", Cruise), Station, sep="-")))
ghc[["labels"]]   <- cbind(ghc[["labels"]], e[ord,])

ggdendrogram(hc, rotate = FALSE)+
  geom_point(data=label(ghc), aes(x, y, fill=Habitat), size=4, pch=21, colour=gray(0, 0.2))+
  scale_fill_viridis(discrete = TRUE)
```

# Nonmetric Multidimensional Scaling
```{r, fig.width=8, fig.height=3}
md <- metaMDS(vegdist(b^0.25))
stress <- paste("Stress = ", deparse(round(md$stress,2)))

# Merge MDS to environmental data frame
ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5) +
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

# Weighted Averages Scores for Species
## Most abundant species in the canyon and on the slope
```{r, fig.width=8, fig.height=3}
# Top 5 most abundant species
can <- sort(colSums(b[e$Habitat=="Canyon", ]), decreasing = TRUE)[1:5]
slo <- sort(colSums(b[e$Habitat=="Slope", ]), decreasing = TRUE)[1:5]

can <- data.frame(wascores(md$points, b[, names(can)]))
can$label <- gsub("_", " ", row.names(can))
slo <- data.frame(wascores(md$points, b[, names(slo)]))
slo$label <- gsub("_", " ", row.names(slo))

lab <- rbind(cbind(can, Habitat="Canyon"), cbind(slo, Habitat="Slope"))

ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5)+
  geom_label_repel(data=lab, aes(x=MDS1, y=MDS2, label=label), 
             colour="white", size=4, label.padding = unit(0.2, "lines"))+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

## Buccal morphology
```{r, fig.width=8, fig.height=3}
tr <- aggregate(t(b), by=list(s$Buccal), FUN=sum)
buc <- data.frame(t(tr[,-1]))
names(buc) <- tr$Group.1
lab <- data.frame(wascores(md$points, decostand(buc, "total")))
lab$label <- row.names(lab)
lab$descrip <- c("selective deposit feeder", "non-selective deposit feeder", "epigrowth feeder", "predator", "mouthless")

ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5)+
  geom_label_repel(data=lab, aes(label=label), fill=viridis(3)[2],
             colour="white", size=10, label.padding = unit(0.2, "lines"))+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

## Tail shape
```{r, fig.width=8, fig.height=3}
tr <- aggregate(t(b), by=list(s$Tail), FUN=sum)
tai <- data.frame(t(tr[,-1]))
names(tai) <- tr$Group.1
lab <- data.frame(wascores(md$points, decostand(tai, "total")))
lab$label <- row.names(lab)
lab$descrip <- c("clavate", "conical", "elongated/filiform", "short/round")

ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5)+
  geom_label_repel(data=lab, aes(label=label), fill=viridis(3)[2],
             colour="white", size=10, label.padding = unit(0.2, "lines"))+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```
## Life history strategy
```{r, fig.width=8, fig.height=3}
tr <- aggregate(t(b), by=list(s$Life.history), FUN=sum)
lif <- data.frame(t(tr[,-1]))
names(lif) <- tr$Group.1
lab <- data.frame(wascores(md$points, decostand(lif, "total")))
lab$label <- row.names(lab)

ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2, fill=Habitat, colour=Habitat))+
  geom_point(pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5)+
  geom_label_repel(data=lab, aes(label=label), fill=viridis(3)[2],
             colour="white", size=10, label.padding = unit(0.2, "lines"))+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

# Correlation among environmental factors
```{r}
# Normalized enivronmental data to mean zero and unit variance
es <- as.data.frame(scale(e[, c(-1:-9, -11:-13, -35)]))
# Calculate absolute correlation coefficient
co <- as.dist(matrix(1, nrow=22, ncol=22)-abs(cor(es, use="pairwise.complete.obs")))
hc <- hclust(co, method="average")

# Convert dendrogram to ggplot style
dhc <- as.dendrogram(hc)
ghc    <- dendro_data(dhc, type="rectangle") 

ggdendrogram(hc, rotate = FALSE)+
  geom_hline(yintercept=0.1, linetype=2, colour="red")
```

"Salinity", "CN", "transmissometer", "Silt", "over20", "Sand", "Speed", "TOC", "Clay", "Temperature" will be retained for initial RDA analysis

# Distance based redundency analysis
## Full model
```{r, fig.width=8, fig.height=3}
db <- dbrda(b^0.25~Salinity+CN+transmissometer+Silt+over20+Sand+Speed+TOC+Clay+Temperature, distance = "bray", data=es)
fit <- as.data.frame(db$CCA$biplot)
sc <- min(abs(c(range(db$CCA$u[,1]), range(db$CCA$u[,1]))))
fit <- fit*sc
fit <- cbind(fit, label=c("Salin", "CN", "Trans", "Sil", "Over20", "San", "Spd", "TOC", "Temp"))

ggplot(data=cbind(as.data.frame(db$CCA$u), e), aes(x=dbRDA1, y=dbRDA2))+
  geom_point(size=10, pch=21, colour=gray(0, 0.2), alpha=0.8, aes(fill=Habitat))+
  #stat_ellipse(type="norm", aes(colour=Habitat))+
  geom_segment(data=fit, aes(x=0, y=0, xend=dbRDA1, yend=dbRDA2), size=1,
               arrow = arrow(length = unit(0.2,"cm")), colour=viridis(3)[2])+
  geom_label_repel(data=fit, aes(x=dbRDA1, y=dbRDA2, label=label), fill=viridis(3)[2], colour="white", size=4, fontface = "bold")+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

su <- summary(db)
cat("Constrained proportion = ", round(su$constr.chi/su$tot.chi*100, 1), "%", "\n",
    "Unconstrained proportion = ", round(su$unconst.chi/su$tot.chi*100, 1), "%", "\n",
    "dbRDA1 explains", round(su$cont$importance[2, 1]*100,1), "% of fit", 
    "and", round(su$cont$importance[2, 1]*100*su$constr.chi/su$tot.chi, 1), "% of total", "\n",
    "dbRDA2 explains", round(su$cont$importance[2, 2]*100,1), "% of fit", 
    "and", round(su$cont$importance[2, 2]*100*su$constr.chi/su$tot.chi, 1), "% of total")
```

## Model selection based on adjust R2
```{r, fig.width=8, fig.height=3}
ordistep(db, permutations=999)
db <- dbrda(b^0.25~Speed+CN+Salinity+over20+TOC+transmissometer+Temperature, distance = "bray", data=es)
fit <- as.data.frame(db$CCA$biplot)
sc <- min(abs(c(range(db$CCA$u[,1]), range(db$CCA$u[,1]))))
fit <- fit*sc
fit <- cbind(fit, label=c("Spd", "CN", "Salin", "Over20", "TOC", "Trans", "Temp"))

ggplot(data=cbind(as.data.frame(db$CCA$u), e), aes(x=dbRDA1, y=dbRDA2))+
  geom_point(size=10, pch=21, colour=gray(0, 0.2), alpha=0.8, aes(fill=Habitat))+
  #stat_ellipse(type="norm", aes(colour=Habitat))+
  geom_segment(data=fit, aes(x=0, y=0, xend=dbRDA1, yend=dbRDA2), size=1,
               arrow = arrow(length = unit(0.2,"cm")), colour=viridis(3)[2])+
  geom_label_repel(data=fit, aes(x=dbRDA1, y=dbRDA2, label=label), fill=viridis(3)[2], colour="white", size=4, fontface = "bold")+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

su <- summary(db)
cat("Constrained proportion = ", round(su$constr.chi/su$tot.chi*100, 1), "%", "\n",
    "Unconstrained proportion = ", round(su$unconst.chi/su$tot.chi*100, 1), "%", "\n",
    "dbRDA1 explains", round(su$cont$importance[2, 1]*100,1), "% of fit", 
    "and", round(su$cont$importance[2, 1]*100*su$constr.chi/su$tot.chi, 1), "% of total", "\n",
    "dbRDA2 explains", round(su$cont$importance[2, 2]*100,1), "% of fit", 
    "and", round(su$cont$importance[2, 2]*100*su$constr.chi/su$tot.chi, 1), "% of total")
```

# Correlation between environmental variables and nMDS ordination 
```{r, fig.width=8, fig.height=3}
fit <- envfit(md$points, es[, c("Speed", "CN", "Salinity", "over20", "TOC", "transmissometer", "Temperature")])
lab <- data.frame(fit$vectors$arrows*0.4)
lab$label <- row.names(lab)

ggplot(data=cbind(md$points, e), aes(x=MDS1, y=MDS2))+
  geom_point(aes(fill=Habitat, colour=Habitat), pch=21, alpha=0.8, size=5, colour=gray(0, 0.2))+
  stat_ellipse(aes(fill=Habitat, colour=Habitat), type="norm")+
  annotate("text", x=-0.45, y=-0.4, label=stress, size=5)+
  geom_segment(data=lab, aes(x=0, y=0, xend=MDS1, yend=MDS2), size=1, arrow = arrow(length = unit(0.2,"cm")), colour=viridis(3)[2])+
  geom_label_repel(data=lab, aes(label=label), fill=viridis(3)[2],
             colour="white", size=5, label.padding = unit(0.2, "lines"))+
  scale_fill_viridis(discrete = TRUE)+
  scale_color_viridis(discrete = TRUE)+
  theme_bw() %+replace% large
```

# Beta diversity along canyon and slope transect
```{r, fig.width=8, fig.height=3}
bl <- splitBy(~Cruise+Habitat, cbind(b, e[,c("Cruise", "Habitat")]))
bl <- lapply(bl, FUN=function(x)decostand(x[, -164:-165], "pa"))
bd <- lapply(bl, FUN=function(x)ldply(beta.multi(x, "sorensen"), .id="Beta"))
bd <- ldply(bd)
fr <- ldply(strsplit(bd$.id, split="[|]"))
names(fr) <- c("Cruise", "Habitat")
bd <- cbind(fr, bd[, -1])
names(bd)[4] <- "Dissim"
bd <- summaryBy(Dissim~Habitat+Beta, data=bd, FUN=c(mean, sd))
bd$Beta <- factor(bd$Beta, levels=c("beta.SOR", "beta.SIM", "beta.SNE"))
levels(bd$Beta) <- c("Sorensen", "Turnover", "Nestedness")

ggplot(data=subset(bd, Beta!="beta.SOR"), 
       aes(x=Habitat, y=Dissim.mean, ymin=Dissim.mean, 
           ymax=Dissim.mean+Dissim.sd, fill=Beta, colour=Beta))+
  geom_bar(stat="identity", position="dodge")+
  geom_errorbar(position="dodge")+
  ylab("Dissimilarity")+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

# Beta diversity
kable(bd)

# Relative contribution
bd[1:3, 3] <- bd[1:3, 3]/bd[3, 3]
bd[4:6, 3] <- bd[4:6, 3]/bd[6, 3]
kable(bd[, -4])
```

# Beta diversity between canyon and slope site 
```{r, fig.width=8, fig.height=3}
bl <- splitBy(~Cruise+Zone, cbind(b, e[,c("Cruise", "Zone")]))
bl <- lapply(bl, FUN=function(x)decostand(x[, -164:-165], "pa"))
bd <- lapply(bl, FUN=function(x)ldply(beta.multi(x, "sorensen"), .id="Beta"))
bd <- ldply(bd)
fr <- ldply(strsplit(bd$.id, split="[|]"))
names(fr) <- c("Cruise", "Zone")
bd <- cbind(fr, bd[, -1])
names(bd)[4] <- "Dissim"
bd <- summaryBy(Dissim~Zone+Beta, data=bd, FUN=c(mean, sd))
bd$Beta <- factor(bd$Beta, levels=c("beta.SOR", "beta.SIM", "beta.SNE"))
levels(bd$Beta) <- c("Sorensen", "Turnover", "Nestedness")

ggplot(data=subset(bd, Beta!="beta.SOR"), 
       aes(x=Zone, y=Dissim.mean, ymin=Dissim.mean, 
           ymax=Dissim.mean+Dissim.sd, fill=Beta, colour=Beta))+
  geom_bar(stat="identity", position="dodge")+
  geom_errorbar(position="dodge")+
  ylab("Dissimilarity")+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)+
  theme_bw() %+replace% large

# Beta diversity
kable(bd)

# Relative contribution
bd[1:3, 3] <- bd[1:3, 3]/bd[3, 3]
bd[4:6, 3] <- bd[4:6, 3]/bd[6, 3]
kable(bd[, -4])
```

